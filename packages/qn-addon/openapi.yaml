openapi: 3.0.3
info:
  title: Veil Privacy Suite — QuickNode Add-On
  description: |
    End-to-end encryption, secret sharing, and ZK compression for Solana dApps.
    MEV-protect orders, manage encrypted state, and gate features by on-chain reputation.

    ## Features
    - **NaCl Box Encryption** — Curve25519-XSalsa20-Poly1305 for end-to-end encrypted messaging
    - **Shamir Secret Sharing** — M-of-N threshold schemes for multi-party key management
    - **Order Encryption** — MEV-protected swap orders for Solana DEX integrations
    - **ZK Compression** — Light Protocol integration for 99% state cost reduction
    - **Payload Serialization** — Type-safe binary encoding for on-chain data

    ## Authentication
    API endpoints use rate limiting (100 requests/minute).
    Provisioning endpoints require HTTP Basic Auth.
  version: 0.1.0
  contact:
    name: Veil Privacy Suite Support
    email: support@veil-privacy.dev
  license:
    name: MIT

servers:
  - url: http://localhost:3030
    description: Local development
  - url: https://your-addon.example.com
    description: Production

tags:
  - name: Crypto
    description: NaCl box encryption and key management
  - name: Threshold
    description: Shamir's Secret Sharing operations
  - name: Orders
    description: MEV-protected order encryption for Solana swaps
  - name: Payload
    description: Binary payload serialization with named schemas
  - name: Compression
    description: ZK compression via Light Protocol
  - name: Provisioning
    description: QuickNode Marketplace lifecycle endpoints
  - name: Health
    description: Service health monitoring

paths:
  /healthcheck:
    get:
      tags: [Health]
      summary: Health check
      description: Returns service health status. No authentication required.
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /:
    get:
      tags: [Health]
      summary: Service info and endpoint catalog
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: "Veil Privacy Suite \u2014 QuickNode Add-On"
                  version:
                    type: string
                    example: "0.1.0"
                  endpoints:
                    type: object

  # === CRYPTO ENDPOINTS ===

  /v1/keypair/generate:
    post:
      tags: [Crypto]
      summary: Generate encryption keypair
      description: Generates a new random X25519 encryption keypair for NaCl box operations.
      responses:
        '200':
          description: Generated keypair
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeypairResponse'
              example:
                success: true
                publicKey:
                  base64: "dGhpcyBpcyBhIHRlc3QgcHVibGljIGtleQ=="
                  hex: "7468697320697320612074657374207075626c6963206b6579"
                secretKey:
                  base64: "dGhpcyBpcyBhIHRlc3Qgc2VjcmV0IGtleQ=="
                  hex: "746869732069732061207465737420736563726574206b6579"

  /v1/keypair/derive:
    post:
      tags: [Crypto]
      summary: Derive keypair from seed
      description: Deterministically derives an X25519 keypair from a 32-byte seed. Same seed always produces the same keypair.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [seed]
              properties:
                seed:
                  type: string
                  format: base64
                  description: 32-byte seed encoded as base64
      responses:
        '200':
          description: Derived keypair
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeypairResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/encrypt:
    post:
      tags: [Crypto]
      summary: Encrypt data
      description: |
        Encrypts plaintext using NaCl box (Curve25519-XSalsa20-Poly1305).
        The `bytes` field in the response contains the combined nonce + ciphertext for on-chain storage.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [plaintext, recipientPublicKey, senderSecretKey, senderPublicKey]
              properties:
                plaintext:
                  type: string
                  format: base64
                  description: Data to encrypt (base64)
                recipientPublicKey:
                  type: string
                  format: base64
                  description: Recipient's X25519 public key (base64)
                senderSecretKey:
                  type: string
                  format: base64
                  description: Sender's secret key (base64)
                senderPublicKey:
                  type: string
                  format: base64
                  description: Sender's public key (base64)
      responses:
        '200':
          description: Encrypted data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncryptedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/decrypt:
    post:
      tags: [Crypto]
      summary: Decrypt data
      description: Decrypts NaCl box ciphertext back to plaintext.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bytes, senderPublicKey, recipientSecretKey, recipientPublicKey]
              properties:
                bytes:
                  type: string
                  format: base64
                  description: Combined nonce + ciphertext (base64)
                senderPublicKey:
                  type: string
                  format: base64
                recipientSecretKey:
                  type: string
                  format: base64
                recipientPublicKey:
                  type: string
                  format: base64
      responses:
        '200':
          description: Decrypted plaintext
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  plaintext:
                    $ref: '#/components/schemas/EncodedBytes'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/crypto/encrypt-multiple:
    post:
      tags: [Crypto]
      summary: Encrypt for multiple recipients
      description: |
        Encrypts the same plaintext for up to 50 recipients simultaneously.
        Each recipient gets their own encrypted copy with a unique nonce.
        Useful for broadcast messaging, group notifications, or multi-party protocols.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [plaintext, recipientPublicKeys, senderSecretKey, senderPublicKey]
              properties:
                plaintext:
                  type: string
                  format: base64
                recipientPublicKeys:
                  type: array
                  items:
                    type: string
                    format: base64
                  minItems: 1
                  maxItems: 50
                  description: Array of recipient X25519 public keys (base64)
                senderSecretKey:
                  type: string
                  format: base64
                senderPublicKey:
                  type: string
                  format: base64
      responses:
        '200':
          description: Encrypted data for each recipient
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  recipientCount:
                    type: integer
                  recipients:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/EncryptedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/crypto/validate:
    post:
      tags: [Crypto]
      summary: Validate encrypted data structure
      description: |
        Validates that encrypted bytes have the correct NaCl box structure
        (nonce + ciphertext) without decrypting. Useful as a pre-flight check
        before attempting decryption.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bytes]
              properties:
                bytes:
                  type: string
                  format: base64
                  description: Encrypted bytes to validate
                minPlaintextSize:
                  type: integer
                  default: 1
                  description: Minimum expected plaintext size in bytes
                maxPlaintextSize:
                  type: integer
                  default: 1024
                  description: Maximum expected plaintext size in bytes
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  valid:
                    type: boolean
                    description: Whether the data has valid NaCl box structure
                  byteLength:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/crypto/key-convert:
    post:
      tags: [Crypto]
      summary: Convert between key formats
      description: |
        Converts encryption public keys between raw bytes (base64/hex) and
        Solana base58 format. Provide either `publicKey` or `base58`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                publicKey:
                  type: string
                  format: base64
                  description: Public key as base64 (converts to base58)
                base58:
                  type: string
                  description: Public key as base58 (converts to bytes)
      responses:
        '200':
          description: Converted key in both formats
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  base58:
                    type: string
                  publicKey:
                    $ref: '#/components/schemas/EncodedBytes'
        '400':
          $ref: '#/components/responses/BadRequest'

  # === THRESHOLD ENDPOINTS ===

  /v1/threshold/split:
    post:
      tags: [Threshold]
      summary: Split secret into shares
      description: |
        Splits a 32-byte secret into N shares using Shamir's Secret Sharing.
        Any M (threshold) shares can reconstruct the original secret.
        Uses polynomial evaluation over a 256-bit prime field.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [secret, threshold, totalShares]
              properties:
                secret:
                  type: string
                  format: base64
                  description: 32-byte secret to split (base64)
                threshold:
                  type: integer
                  minimum: 2
                  description: Minimum shares needed to reconstruct (M)
                totalShares:
                  type: integer
                  minimum: 2
                  maximum: 255
                  description: Total shares to generate (N)
      responses:
        '200':
          description: Generated shares
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  shares:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecretShare'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/threshold/combine:
    post:
      tags: [Threshold]
      summary: Combine shares to reconstruct secret
      description: Reconstructs the original secret from threshold shares using Lagrange interpolation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [shares]
              properties:
                shares:
                  type: array
                  minItems: 2
                  items:
                    $ref: '#/components/schemas/SecretShare'
      responses:
        '200':
          description: Reconstructed secret
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  secret:
                    $ref: '#/components/schemas/EncodedBytes'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/threshold/verify:
    post:
      tags: [Threshold]
      summary: Verify share consistency
      description: |
        Verifies that a set of shares are consistent by attempting partial
        reconstruction with different subsets. If two different subsets of
        threshold shares produce the same secret, the shares are valid.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [shares, threshold]
              properties:
                shares:
                  type: array
                  minItems: 2
                  items:
                    $ref: '#/components/schemas/SecretShare'
                threshold:
                  type: integer
                  minimum: 2
                  description: Expected threshold for these shares
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  valid:
                    type: boolean
                    description: Whether shares are consistent
                  sharesProvided:
                    type: integer
                  threshold:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  # === ORDERS ENDPOINTS ===

  /v1/orders/encrypt:
    post:
      tags: [Orders]
      summary: Encrypt swap order
      description: |
        Encrypts a swap order payload (minOutputAmount, slippageBps, deadline)
        using NaCl box. Only the designated solver can decrypt.
        Protects order parameters from MEV bots before on-chain submission.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [minOutputAmount, slippageBps, deadline, solverPublicKey, userSecretKey, userPublicKey]
              properties:
                minOutputAmount:
                  type: string
                  description: Minimum output amount (lamports/smallest unit)
                  example: "5000000"
                slippageBps:
                  type: integer
                  description: Slippage tolerance in basis points (50 = 0.5%)
                  example: 50
                deadline:
                  type: integer
                  description: Unix timestamp for order expiration
                  example: 1700000000
                solverPublicKey:
                  type: string
                  format: base64
                userSecretKey:
                  type: string
                  format: base64
                userPublicKey:
                  type: string
                  format: base64
      responses:
        '200':
          description: Encrypted order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncryptedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/orders/decrypt:
    post:
      tags: [Orders]
      summary: Decrypt swap order
      description: Decrypts an encrypted swap order. Only the solver with the correct keypair can decrypt.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bytes, userPublicKey, solverSecretKey, solverPublicKey]
              properties:
                bytes:
                  type: string
                  format: base64
                userPublicKey:
                  type: string
                  format: base64
                solverSecretKey:
                  type: string
                  format: base64
                solverPublicKey:
                  type: string
                  format: base64
      responses:
        '200':
          description: Decrypted order payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  payload:
                    type: object
                    properties:
                      minOutputAmount:
                        type: string
                      slippageBps:
                        type: integer
                      deadline:
                        type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/orders/validate:
    post:
      tags: [Orders]
      summary: Validate encrypted order
      description: |
        Validates that encrypted bytes have the correct structure for a swap order
        (correct size range for NaCl box + serialized order payload) without decrypting.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bytes]
              properties:
                bytes:
                  type: string
                  format: base64
                  description: Encrypted order bytes to validate
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  valid:
                    type: boolean
                  byteLength:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  # === PAYLOAD ENDPOINTS ===

  /v1/payload/serialize:
    post:
      tags: [Payload]
      summary: Serialize data to binary
      description: Encodes structured data to fixed-size binary format using a named schema.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [data, schema]
              properties:
                data:
                  type: object
                  description: Key-value data to serialize
                schema:
                  type: string
                  enum: [SWAP_ORDER, RWA_ASSET, RWA_ACCESS_GRANT]
                  description: Named schema to use
      responses:
        '200':
          description: Serialized bytes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  bytes:
                    $ref: '#/components/schemas/EncodedBytes'
                  size:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/payload/deserialize:
    post:
      tags: [Payload]
      summary: Deserialize binary to data
      description: Decodes binary bytes back to structured data using a named schema.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bytes, schema]
              properties:
                bytes:
                  type: string
                  format: base64
                schema:
                  type: string
                  enum: [SWAP_ORDER, RWA_ASSET, RWA_ACCESS_GRANT]
      responses:
        '200':
          description: Deserialized data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
        '400':
          $ref: '#/components/responses/BadRequest'

  # === COMPRESSION ENDPOINTS ===

  /v1/compression/estimate:
    get:
      tags: [Compression]
      summary: Estimate compression savings
      description: Calculates the cost difference between storing data uncompressed vs. ZK-compressed on Solana.
      parameters:
        - name: size
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: Data size in bytes
      responses:
        '200':
          description: Cost estimation
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  dataSize:
                    type: integer
                  uncompressedCost:
                    type: string
                    description: Cost in lamports without compression
                  compressedCost:
                    type: string
                    description: Cost in lamports with ZK compression
                  savings:
                    type: string
                    description: Savings in lamports
                  savingsPercent:
                    type: number
                    description: Percentage saved
              example:
                success: true
                dataSize: 1000
                uncompressedCost: "6960"
                compressedCost: "100"
                savings: "6860"
                savingsPercent: 98.56

  /v1/compression/compress:
    post:
      tags: [Compression]
      summary: Compress data with ZK proof
      description: |
        Compresses data using Light Protocol ZK compression.
        Requires a provisioned instance with an RPC URL that supports Light Protocol.
      parameters:
        - $ref: '#/components/parameters/InstanceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [data, payerSecretKey]
              properties:
                data:
                  type: string
                  format: base64
                payerSecretKey:
                  type: string
                  format: base64
                  description: Payer's secret key for transaction fees
      responses:
        '200':
          description: Compressed data with ZK proof
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  compressedData:
                    type: string
                    format: base64
                  proof:
                    type: string
                    format: base64
                  publicInputs:
                    type: string
                    format: base64
                  stateTreeRoot:
                    type: string
                    format: base64
                  dataHash:
                    type: string
                    format: base64

  /v1/compression/decompress:
    post:
      tags: [Compression]
      summary: Decompress ZK-compressed data
      description: Reconstructs original data from compressed payload and ZK proof.
      parameters:
        - $ref: '#/components/parameters/InstanceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [compressedData, proof, publicInputs, stateTreeRoot, dataHash]
              properties:
                compressedData:
                  type: string
                  format: base64
                proof:
                  type: string
                  format: base64
                publicInputs:
                  type: string
                  format: base64
                stateTreeRoot:
                  type: string
                  format: base64
                dataHash:
                  type: string
                  format: base64
      responses:
        '200':
          description: Decompressed data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: string
                    format: base64

  # === PROVISIONING ENDPOINTS ===

  /provision:
    post:
      tags: [Provisioning]
      summary: Provision new instance
      description: Called by QuickNode after successful user payment. Creates a new instance record.
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["quicknode-id", "endpoint-id", plan]
              properties:
                quicknode-id:
                  type: string
                endpoint-id:
                  type: string
                plan:
                  type: string
                wss-url:
                  type: string
                http-url:
                  type: string
                chain:
                  type: string
                network:
                  type: string
      responses:
        '200':
          description: Provisioned
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Unauthorized

  /update:
    put:
      tags: [Provisioning]
      summary: Update instance
      description: Called by QuickNode on plan changes or token rotation.
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["endpoint-id"]
              properties:
                endpoint-id:
                  type: string
                plan:
                  type: string
                wss-url:
                  type: string
                http-url:
                  type: string
                chain:
                  type: string
                network:
                  type: string
      responses:
        '200':
          description: Updated
        '404':
          description: Instance not found

  /deactivate_endpoint:
    delete:
      tags: [Provisioning]
      summary: Deactivate endpoint
      description: Disables a specific endpoint without deleting it.
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["endpoint-id"]
              properties:
                endpoint-id:
                  type: string
      responses:
        '200':
          description: Deactivated
        '404':
          description: Not found

  /deprovision:
    delete:
      tags: [Provisioning]
      summary: Deprovision instance
      description: Completely removes all instances for a QuickNode ID. Called on unsubscription.
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["quicknode-id"]
              properties:
                quicknode-id:
                  type: string
      responses:
        '200':
          description: Deprovisioned

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: HTTP Basic Auth for provisioning endpoints

  parameters:
    InstanceId:
      name: X-INSTANCE-ID
      in: header
      required: true
      schema:
        type: string
      description: Instance ID from provisioning (endpoint-id)

  schemas:
    EncodedBytes:
      type: object
      properties:
        base64:
          type: string
          format: base64
        hex:
          type: string

    KeypairResponse:
      type: object
      properties:
        success:
          type: boolean
        publicKey:
          $ref: '#/components/schemas/EncodedBytes'
        secretKey:
          $ref: '#/components/schemas/EncodedBytes'

    EncryptedResponse:
      type: object
      properties:
        success:
          type: boolean
        nonce:
          $ref: '#/components/schemas/EncodedBytes'
        ciphertext:
          $ref: '#/components/schemas/EncodedBytes'
        bytes:
          $ref: '#/components/schemas/EncodedBytes'

    SecretShare:
      type: object
      properties:
        index:
          type: integer
          description: Share index (1-based)
        value:
          type: string
          format: base64
          description: Share value (base64)

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
